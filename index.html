<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>cXc Pangea Integration</title>
  <!-- Updated for GitHub Pages deployment -->
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <header>
    <div class="brand">
      <span class="logo">cXc</span>
      <span class="subtitle">Pangea Passport</span>
    </div>
    <div class="auth-controls">
      <select id="networkSelect">
        <option value="pangea">Pangea (Tonomy)</option>
        <option value="eos">EOS Mainnet</option>
        <option value="jungle">Jungle</option>
        <option value="custom">Custom</option>
      </select>
      <input id="customRpc" class="hidden" placeholder="Custom RPC" />
      <input id="customChainId" class="hidden" placeholder="Custom Chain ID" />
      <select id="signerSelect">
        <option value="auto">Auto: Tonomy / Anchor</option>
        <option value="tonomy">Tonomy ID</option>
        <option value="esr">Tonomy ESR (Deep Link)</option>
        <option value="anchor">Anchor Link</option>
      </select>
    </div>
    <button id="connectBtn" class="btn primary">Connect</button>
  </header>

  <section class="card" id="esrCard">
    <h2>ESR Deep Link</h2>
    <p>Generate a deep link or QR-ready URI for Tonomy Wallet when using ESR mode.</p>
    <div class="grid">
      <div>
        <label>Latest ESR URI</label>
        <textarea id="esrUri" readonly placeholder="Generated ESR URI will appear here"></textarea>
      </div>
      <div>
        <label>Deep Link (opens Tonomy)</label>
        <input id="esrDeepLink" readonly placeholder="tonomy://sign?request=..." />
        <button id="openEsr" class="btn secondary">Open in Tonomy</button>
      </div>
    </div>
    <div id="esrStatus" class="hint"></div>
  </section>

  <main>
    <section class="card">
      <h2>Onboarding</h2>
      <p>Resume the guided flow: welcome -> create account -> invite code -> verification -> tutorial.</p>
      <div id="onboardingList" class="step-list"></div>
      <div class="actions">
        <button id="onboardingNext" class="btn primary">Next step</button>
        <button id="onboardingReset" class="btn secondary">Restart</button>
        <span id="onboardingStatus" class="hint"></span>
      </div>
    </section>

    <section class="card two-column">
      <div>
        <h2>Invite Friends</h2>
        <p>Share your username to earn tetrahedral BLUX rewards.</p>
        <label>Inviter Code</label>
        <input id="inviteCode" placeholder="alice.cxc">
        <label>Invite New User</label>
        <input id="inviteTarget" placeholder="bob.cxc">
        <button id="sendInvite" class="btn primary">Send Invite</button>
        <div id="inviteResult" class="hint"></div>
      </div>
      <div>
        <h3>Your Stats</h3>
        <div id="stats" class="stat-grid">
          <div><span>Direct</span><strong>0</strong></div>
          <div><span>Network</span><strong>0</strong></div>
          <div><span>Rewards</span><strong>0 BLUX</strong></div>
        </div>
      </div>
    </section>

    <section class="card two-column">
      <div>
        <h2>Daily Upvotes</h2>
        <p>Claim daily upvotes based on your Passport verification level.</p>
        <button id="claimUpvotes" class="btn primary">Claim Daily Upvotes</button>
        <div id="upvoteStatus" class="hint"></div>
      </div>
      <div>
        <h3>Allocation</h3>
        <div id="upvoteMeter" class="meter">
          <div class="fill" style="width: 0%"></div>
        </div>
        <div id="upvoteCounts" class="hint">0 / 0 upvotes</div>
      </div>
    </section>

    <section class="card">
      <h2>Referral Dashboard</h2>
      <p>Track downstream invites and invite status.</p>
      <div id="referralTotals" class="hint">Connect to load referrals.</div>
      <div id="referralList" class="list-box">â€”</div>
    </section>

    <section class="card">
      <h2>Bridge BLUX: WAX -> Tonomy</h2>
      <div id="bridgeStepper" class="stepper">
        <div class="step" data-step="memo"><div class="badge">1</div><div>Generate memo</div></div>
        <div class="step" data-step="lock"><div class="badge">2</div><div>Lock on WAX</div></div>
        <div class="step" data-step="mint"><div class="badge">3</div><div>Mint on Tonomy</div></div>
      </div>
      <div class="grid">
        <div>
          <label>Amount (BLUX)</label>
          <input id="bridgeAmount" type="number" min="1" step="0.0001" placeholder="100.0000">
        </div>
        <div>
          <label>Tonomy Account</label>
          <input id="tonomyAccount" placeholder="alice.cxc">
        </div>
        <div>
          <label>WAX Account</label>
          <input id="waxAccount" placeholder="alice.wam">
        </div>
        <div>
          <label>Bridge Memo</label>
          <input id="bridgeMemo" placeholder="TRANSFER_..." readonly>
        </div>
      </div>
      <button id="bridgeBtn" class="btn primary">Bridge Tokens</button>
      <button id="bridgeCheckBtn" class="btn secondary">Check Bridge Status</button>
      <div class="hint">
        Explorer: <a id="bridgeExplorerWax" class="hidden" target="_blank" rel="noreferrer">WAX tx</a>
        <a id="bridgeExplorerTonomy" class="hidden" target="_blank" rel="noreferrer">Tonomy tx</a>
      </div>
      <div id="bridgeStatus" class="hint"></div>
    </section>
  </main>

  <!-- eosjs globals for browser usage -->
  <script src="https://cdn.jsdelivr.net/npm/eosjs@22.1.0/dist/eosjs-jsonrpc.min.js" integrity="sha256-Zl7UsYjx3MHJb2i2McOMnvou+EGb/R58jFb3QaJbxV4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/eosjs@22.1.0/dist/eosjs-jssig.min.js" integrity="sha256-N3WFw9XcGO2YsQg8oqwiCB3Up5Zdwqs7GgZvs8o+pZk=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/eosjs@22.1.0/dist/eosjs-api.min.js" integrity="sha256-+11QtS9v0XR3p4cLrdu/kHzKf6Mr7R/4BIqwl2fv9H4=" crossorigin="anonymous"></script>
  <!-- Anchor Link + Tonomy ID SDK globals for browser usage -->
  <script type="module">
    import AnchorLink from "https://cdn.jsdelivr.net/npm/anchor-link@3.5.1/dist/anchorlink.browser.esm.js";
    import AnchorLinkBrowserTransport from "https://cdn.jsdelivr.net/npm/anchor-link-browser-transport@3.5.1/dist/anchorlink-browser-transport.browser.esm.js";
    import { createTonomyId } from "https://cdn.jsdelivr.net/npm/@tonomy/tonomy-id-sdk@0.6.2/dist/tonomy-id-sdk.esm.js";
    window.AnchorLink = AnchorLink;
    window.AnchorLinkBrowserTransport = AnchorLinkBrowserTransport;
    window.createTonomyId = createTonomyId;
  </script>
  <script type="module">
    import { SigningRequest } from "https://cdn.jsdelivr.net/npm/@wharfkit/signing-request/+esm";
    import { APIClient } from "https://cdn.jsdelivr.net/npm/@wharfkit/antelope/+esm";
    import { ABICache } from "https://cdn.jsdelivr.net/npm/@wharfkit/abicache/+esm";
    import pako from "https://cdn.jsdelivr.net/npm/pako@2/+esm";

    let currentChainId = "aca376f206b8fc25a6ed44dbdc66547c36c6c33e3d119416cf6838fb94c5a37a";
    let currentRpc = "https://eos.greymass.com";
    let client = new APIClient({ url: currentRpc });
    let abiCache = new ABICache(client);

    function setNetwork({ chainId, rpcEndpoint }) {
      currentChainId = chainId || currentChainId;
      currentRpc = rpcEndpoint || currentRpc;
      client = new APIClient({ url: currentRpc });
      abiCache = new ABICache(client);
    }

    async function createEsr(actions, options = {}) {
      const request = await SigningRequest.create(
        {
          actions,
          broadcast: options.broadcast !== false,
          callback: options.callback,
          chainId: options.chainId || currentChainId,
        },
        { abiProvider: abiCache, zlib: pako }
      );
      return request.encode(true, true, "esr");
    }

    async function createIdentityEsr(callbackUrl) {
      const request = SigningRequest.identity({ callback: callbackUrl });
      return request.encode(true, true, "esr");
    }

    async function resolveEsr(esrUri, signerAccount, signerPermission = "active") {
      const request = SigningRequest.from(esrUri, { abiProvider: abiCache, zlib: pako });
      const abis = await request.fetchAbis();
      const info = await client.v1.chain.get_info();
      const header = info.getTransactionHeader();
      const authorization = { actor: signerAccount, permission: signerPermission };
      const resolved = await request.resolve(abis, authorization, header);
      return {
        transaction: resolved.transaction,
        serializedTransaction: resolved.serializedTransaction,
        signingDigest: resolved.signingDigest,
      };
    }

    window.esrHelper = { createEsr, createIdentityEsr, resolveEsr, client: () => client, setNetwork };
  </script>
  <script type="module" src="./app.js"></script>
</body>
</html>
